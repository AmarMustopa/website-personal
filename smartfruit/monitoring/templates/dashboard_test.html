<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        /* Hamburger menu button */
        .hamburger {
            width: 40px;
            height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background: none;
            border: none;
            outline: none;
        }
        .hamburger span {
            display: block;
            width: 26px;
            height: 4px;
            margin: 3px 0;
            background: #fff;
            border-radius: 2px;
            transition: 0.3s;
        }
        /* Sidebar overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.18);
            z-index: 2000;
        }
        .sidebar-menu {
            position: fixed;
            top: 0; left: -260px;
            width: 260px;
            height: 100vh;
            background: #1976a5;
            color: #fff;
            box-shadow: 2px 0 16px #bfcfff;
            z-index: 2100;
            transition: left 0.3s;
            display: flex;
            flex-direction: column;
        }
        .sidebar-menu.open {
            left: 0;
        }
        .sidebar-menu .close-btn {
            align-self: flex-end;
            font-size: 2em;
            background: none;
            border: none;
            color: #fff;
            margin: 12px 16px 0 0;
            cursor: pointer;
        }
        .sidebar-menu ul {
            list-style: none;
            padding: 0;
            margin: 32px 0 0 0;
        }
        .sidebar-menu li {
            padding: 16px 32px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sidebar-menu li:hover {
            background: #15608a;
        }
    </style>
    <meta charset="UTF-8">
    <title>Monitoring Kesegaran Daging Sapi Pintar</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { margin:0; font-family: 'Segoe UI', Arial, sans-serif; background:#f9fafb; }
        .taskbar {
            width: 100vw;
            background: #5a67d8;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            height: 56px;
            box-shadow: 0 2px 8px #e0e7ff;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .taskbar .logo {
            font-size: 1.3em;
            font-weight: bold;
            letter-spacing: 1px;
        }
        .taskbar .nav {
            display: flex;
            gap: 24px;
        }
        .taskbar .nav a {
            color: #fff;
            text-decoration: none;
            font-size: 1em;
            font-weight: 500;
            transition: color 0.2s;
        }
        .taskbar .nav a:hover {
            color: #ffd700;
        }
        .taskbar .auth {
            display: flex;
            gap: 12px;
        }
        .taskbar .auth button {
            background: #fff;
            color: #5a67d8;
            border: none;
            border-radius: 6px;
            padding: 6px 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .taskbar .auth button:hover {
            background: #ffd700;
            color: #222;
        }
        /* Modal */
        .modal-bg {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.25);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .modal {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 32px #bfcfff;
            padding: 32px 28px 24px 28px;
            min-width: 320px;
            max-width: 90vw;
        }
        .modal h2 { margin-top:0; margin-bottom:18px; color:#5a67d8; }
        .modal label { display:block; margin-bottom:6px; font-weight:500; }
        .modal input[type="text"], .modal input[type="password"], .modal input[type="email"] {
            width:100%; padding:8px; border-radius:6px; border:1px solid #dbeafe; margin-bottom:16px;
        }
        .modal button { background:#5a67d8; color:#fff; border:none; border-radius:6px; padding:8px 18px; font-weight:600; cursor:pointer; }
        .modal .close-btn { background:#eee; color:#5a67d8; float:right; margin-top:-8px; margin-right:-8px; }
        .modal .close-btn:hover { background:#ffd700; color:#222; }
    </style>
    <!-- Taskbar/Navbar -->
    <div class="taskbar">
        <button class="hamburger" onclick="openSidebarMenu()" aria-label="Menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
    <div class="logo" style="flex:1;text-align:center;"><i class="fas fa-lemon"></i> Monitoring Kesegaran Daging Sapi Pintar</div>
        <div class="auth" style="display:flex;gap:12px;">
            {% if user.is_authenticated %}
                <span id="userWelcome" style="font-weight:bold;">ðŸ‘¤ {{ user.username }}</span>
                <button id="logoutBtn" onclick="ajaxLogout()">Logout</button>
            {% else %}
                <button id="loginBtn" onclick="showLogin()">Login</button>
                <button id="registerBtn" onclick="showRegister()">Register</button>
            {% endif %}
        </div>
<!-- Sidebar Slide-out Menu -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebarMenu()"></div>
<nav class="sidebar-menu" id="sidebarMenu">
    <button class="close-btn" onclick="closeSidebarMenu()">&times;</button>
    <ul>
        <li id="engineerMenu" style="position:relative;cursor:pointer;flex-direction:column;align-items:flex-start;">
            <div style="display:flex;align-items:center;gap:12px;width:100%;" onclick="toggleEngineer()">
                <i class="fas fa-cog"></i> Insinyur <i id="engineerArrow" class="fas fa-chevron-down" style="font-size:0.9em;margin-left:8px;"></i>
            </div>
            <ul id="engineerList" style="display:none;width:100%;margin:0;padding:0 0 0 36px;list-style:disc;background:transparent;border-radius:0;box-shadow:none;">
                <li style="padding:6px 0 6px 0;">Amar Mustopa</li>
                <li style="padding:6px 0 6px 0;">Annas Adityaswara</li>
                <li style="padding:6px 0 6px 0;">Riza Asrofi</li>
            </ul>
        </li>
        <li id="jenisSensorMenu" style="position:relative;cursor:pointer;flex-direction:column;align-items:flex-start;">
            <div style="display:flex;align-items:center;gap:12px;width:100%;" onclick="toggleJenisSensor()">
                <i class="fas fa-microchip"></i> Jenis Sensor <i id="jenisSensorArrow" class="fas fa-chevron-down" style="font-size:0.9em;margin-left:8px;"></i>
            </div>
            <ul id="jenisSensorList" style="display:none;width:100%;margin:0;padding:0 0 0 36px;list-style:disc;background:transparent;border-radius:0;box-shadow:none;">
                <li style="padding:6px 0 6px 0;">Sensor DHT22</li>
                <li style="padding:6px 0 6px 0;">Mikrokontroler ESP32</li>
                <li style="padding:6px 0 6px 0;">MQ-135</li>
                <li style="padding:6px 0 6px 0;">MQ-2</li>
                <li style="padding:6px 0 6px 0;">Breadboard</li>
            </ul>
        </li>
        <li><i class="fas fa-chart-bar"></i> Hasil</li>
    </ul>
</nav>
    </div>

    <!-- Modal Login -->
    <div class="modal-bg" id="loginModal">
        <div class="modal">
            <button class="close-btn" onclick="hideLogin()">&times;</button>
            <h2>Masuk</h2>
            <form>
                <label>Nama Pengguna</label>
                <input type="text" id="loginUsername" required>
                <label>Kata Sandi</label>
                <input type="password" id="loginPassword" required>
                <button type="submit" id="loginSubmit">Login</button>
            </form>
        </div>
    </div>
    <!-- Modal Register -->
    <div class="modal-bg" id="registerModal">
        <div class="modal">
            <button class="close-btn" onclick="hideRegister()">&times;</button>
            <h2>Daftar</h2>
            <form>
                <label>Email</label>
                <input type="email" id="registerEmail" required>
                <label>Nama Pengguna</label>
                <input type="text" id="registerUsername" required>
                <label>Kata Sandi</label>
                <input type="password" id="registerPassword" required>
                <button type="submit" id="registerSubmit">Register</button>
            </form>
        </div>
    </div>
    </body>
    </html>
            </ul>
        </nav>
    </aside>
    <main class="main">
        {% if data %}
        <!-- KPI Cards -->
        <div style="display:flex;gap:24px;margin-bottom:24px;">
            <div style="flex:1;background:linear-gradient(120deg,#a3bffa,#e0e7ff);border-radius:18px;padding:32px 28px 24px 28px;box-shadow:0 2px 12px #e3e3e3;display:flex;flex-direction:column;align-items:flex-start;position:relative;">
                <div style="font-size:1.1em;color:#8d99ae;margin-bottom:8px;">Suhu Terakhir</div>
                <div style="font-size:2.5em;font-weight:bold;margin-bottom:8px;letter-spacing:1px;">{{ data.temperature|default:'-'}}Â°C</div>
                <div style="position:absolute;top:24px;right:24px;font-size:2.2em;opacity:0.13;"><i class="fas fa-thermometer-half"></i></div>
            </div>
            <div style="flex:1;background:linear-gradient(120deg,#fbc2eb,#fffde4);border-radius:18px;padding:32px 28px 24px 28px;box-shadow:0 2px 12px #e3e3e3;display:flex;flex-direction:column;align-items:flex-start;position:relative;">
                <div style="font-size:1.1em;color:#8d99ae;margin-bottom:8px;">Kelembapan Terakhir</div>
                <div style="font-size:2.5em;font-weight:bold;margin-bottom:8px;letter-spacing:1px;">{{ data.humidity|default:'-'}}%</div>
                <div style="position:absolute;top:24px;right:24px;font-size:2.2em;opacity:0.13;"><i class="fas fa-tint"></i></div>
            </div>
            <div style="flex:1;background:linear-gradient(120deg,#b9fbc0,#e0ffe4);border-radius:18px;padding:32px 28px 24px 28px;box-shadow:0 2px 12px #e3e3e3;display:flex;flex-direction:column;align-items:flex-start;position:relative;">
                <div style="font-size:1.1em;color:#8d99ae;margin-bottom:8px;">Status Daging</div>
                {% if data.status == 'TIDAK LAYAK' %}
                <div style="font-size:2.5em;font-weight:bold;margin-bottom:8px;letter-spacing:1px;color:#c0392b;">{{ data.status|default:'-' }}</div>
                {% elif data.status == 'WARNING' %}
                <div style="font-size:2.5em;font-weight:bold;margin-bottom:8px;letter-spacing:1px;color:#ff9800;">{{ data.status|default:'-' }}</div>
                {% elif data.status == 'LAYAK' %}
                <div style="font-size:2.5em;font-weight:bold;margin-bottom:8px;letter-spacing:1px;color:#27ae60;">{{ data.status|default:'-' }}</div>
                {% else %}
                <div style="font-size:2.5em;font-weight:bold;margin-bottom:8px;letter-spacing:1px;">{{ data.status|default:'-' }}</div>
                {% endif %}
                <div style="position:absolute;top:24px;right:24px;font-size:2.2em;opacity:0.13;"><i class="fas fa-lemon"></i></div>
            </div>
        </div>

        <!-- Charts -->
        <div style="display:flex;gap:24px;margin-bottom:24px;">
            <div style="flex:2;background:#fff;border-radius:18px;box-shadow:0 2px 12px #e3e3e3;padding:24px 24px 16px 24px;display:flex;flex-direction:column;align-items:stretch;min-width:0;">
                <div style="font-size:1.1em;color:#8d99ae;margin-bottom:12px;">Riwayat Suhu (Â°C)</div>
                <div style="width:100%;height:180px;"><canvas id="tempChart"></canvas></div>
            </div>
            <div style="flex:2;background:#fff;border-radius:18px;box-shadow:0 2px 12px #e3e3e3;padding:24px 24px 16px 24px;display:flex;flex-direction:column;align-items:stretch;min-width:0;">
                <div style="font-size:1.1em;color:#8d99ae;margin-bottom:12px;">Riwayat Kelembapan (%)</div>
                <div style="width:100%;height:180px;"><canvas id="humChart"></canvas></div>
            </div>
            <div style="flex:1;background:#fff;border-radius:18px;box-shadow:0 2px 12px #e3e3e3;padding:24px 16px 16px 16px;display:flex;flex-direction:column;align-items:center;">
                <div style="font-size:1.1em;color:#8d99ae;margin-bottom:12px;">Gas Terakhir</div>
                <canvas id="gasGauge" width="120" height="80"></canvas>
                <div style="font-size:2em;font-weight:bold;color:#5a67d8;margin-top:8px;text-align:center;" id="gaugeValue">{{ data.gas|default:'-' }}</div>
            </div>
        </div>

        <!-- History Table -->
                <style>
                /* Responsive Table & Form */
                @media (max-width: 900px) {
                    #historyTable, #historyTable th, #historyTable td { font-size: 0.95em; }
                    #filterForm { flex-direction: column; align-items: stretch; gap: 8px; }
                }
                @media (max-width: 600px) {
                    #historyTable, #historyTable th, #historyTable td { font-size: 0.85em; }
                    #filterForm { flex-direction: column; align-items: stretch; gap: 6px; }
                    .kpi-card { min-width: 120px; }
                }
                .status-badge {
                    display: inline-block;
                    min-width: 90px;
                    padding: 4px 12px;
                    border-radius: 16px;
                    font-weight: bold;
                    font-size: 1em;
                    text-align: center;
                    letter-spacing: 1px;
                }
                .status-layak { background: #e8f5e9; color: #219150; border: 2px solid #27ae60; }
                .status-warning { background: #fffbe6; color: #b88600; border: 2px solid #ffb300; }
                .status-tidak { background: #ffebee; color: #c0392b; border: 2px solid #c0392b; }
                </style>
                <div style="background:#fff;border-radius:18px;box-shadow:0 2px 12px #e3e3e3;margin-top:32px;padding:24px;">
                    <h3 style="margin-bottom:16px;">Riwayat Data & Status Daging Layak Konsumsi</h3>
                    <form id="filterForm" style="display:flex;gap:16px;align-items:center;margin-bottom:18px;flex-wrap:wrap;">
                        <label>Tanggal: <input type="date" id="filterDate"></label>
                        <label>Jam: <input type="time" id="filterTime"></label>
                        <label>Status:
                            <select id="filterStatus">
                                <option value="">Semua</option>
                                <option value="LAYAK">LAYAK</option>
                                <option value="WARNING">WARNING</option>
                                <option value="TIDAK LAYAK">TIDAK LAYAK</option>
                            </select>
                        </label>
                        <button type="button" id="exportCsvBtn" style="margin-left:auto;background:#5a67d8;color:#fff;border:none;padding:8px 18px;border-radius:6px;font-weight:600;cursor:pointer;">Ekspor CSV</button>
                    </form>
                    <table id="historyTable" style="width:100%;border-collapse:collapse;">
                        <tr style="background:#e0e0e0;">
                            <th style="padding:4px;">Waktu</th>
                            <th style="padding:4px;">Suhu (Â°C)</th>
                            <th style="padding:4px;">Kelembapan (%)</th>
                            <th style="padding:4px;">Gas</th>
                            <th style="padding:4px;">Status</th>
                        </tr>
                        {% for row in history %}
                        <tr>
                            <td style="padding:4px;">{{ row.created_at|date:'Y-m-d H:i:s' }}</td>
                            <td style="padding:4px;">{{ row.temperature|default:'-' }}</td>
                            <td style="padding:4px;">{{ row.humidity|default:'-' }}</td>
                            <td style="padding:4px;">{{ row.gas|default:'-' }}</td>
                            <td style="padding:4px;">
                                {% if row.status == 'TIDAK LAYAK' %}
                                <span class="status-badge status-tidak">TIDAK LAYAK</span>
                                {% elif row.status == 'WARNING' %}
                                <span class="status-badge status-warning">WARNING</span>
                                {% elif row.status == 'LAYAK' %}
                                <span class="status-badge status-layak">LAYAK</span>
                                {% else %}
                                <span class="status-badge">{{ row.status|default:'-' }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>

        {% if history and history|length > 0 %}
        <!-- Chart.js script moved to end of body -->
        {% endif %}
        {% else %}
        <div style="background:#fff;border-radius:18px;box-shadow:0 2px 12px #e3e3e3;margin-top:32px;padding:32px;text-align:center;">
            <h2 style="color:#5a67d8;">Belum ada data sensor masuk atau data tidak lengkap.</h2>
            <p>Silakan kirim data sensor untuk mulai monitoring.</p>
        </div>
        {% endif %}
    </main>
</div>

<script>
// --- Filter & Export Logic ---
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const table = document.getElementById('historyTable');
    const exportBtn = document.getElementById('exportCsvBtn');
    function fetchFilteredHistory() {
        const date = document.getElementById('filterDate').value;
        const time = document.getElementById('filterTime').value;
        const status = document.getElementById('filterStatus').value;
        let url = '/api/history/?';
        if (date) url += 'date=' + date + '&';
        if (time) url += 'time=' + time + '&';
        if (status) url += 'status=' + status + '&';
        fetch(url)
            .then(r => r.json())
            .then(history => {
                let rows = '';
                for (let row of history) {
                    rows += `<tr><td style='padding:4px;'>${row.created_at.replace('T',' ').substr(0,19)}</td><td style='padding:4px;'>${row.temperature ?? '-'}</td><td style='padding:4px;'>${row.humidity ?? '-'}</td><td style='padding:4px;'>${row.gas ?? '-'}</td>`;
                    if (row.status === 'TIDAK LAYAK') rows += `<td style='padding:4px;color:#c0392b;font-weight:bold;'>${row.status}</td>`;
                    else if (row.status === 'WARNING') rows += `<td style='padding:4px;color:#ff9800;font-weight:bold;'>${row.status}</td>`;
                    else if (row.status === 'LAYAK') rows += `<td style='padding:4px;color:#27ae60;font-weight:bold;'>${row.status}</td>`;
                    else rows += `<td style='padding:4px;'>${row.status ?? '-'}</td>`;
                    rows += '</tr>';
                }
                table.querySelectorAll('tr:not(:first-child)').forEach(e => e.remove());
                table.innerHTML += rows;
            });
    }
    filterForm.addEventListener('change', fetchFilteredHistory);
    exportBtn.addEventListener('click', function() {
        const date = document.getElementById('filterDate').value;
        const time = document.getElementById('filterTime').value;
        const status = document.getElementById('filterStatus').value;
        let url = '/export/?';
        if (date) url += 'date=' + date + '&';
        if (time) url += 'time=' + time + '&';
        if (status) url += 'status=' + status + '&';
        window.open(url, '_blank');
    });
});
// --- ALERT POPUP ---
function showAlert(msg) {
    let alertDiv = document.getElementById('alertPopup');
    if (!alertDiv) {
        alertDiv = document.createElement('div');
        alertDiv.id = 'alertPopup';
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '24px';
        alertDiv.style.right = '24px';
        alertDiv.style.background = '#c0392b';
        alertDiv.style.color = '#fff';
        alertDiv.style.padding = '18px 32px';
        alertDiv.style.borderRadius = '12px';
        alertDiv.style.fontSize = '1.2em';
        alertDiv.style.zIndex = 99999;
        alertDiv.style.boxShadow = '0 4px 24px #bfcfff';
        alertDiv.style.display = 'none';
        document.body.appendChild(alertDiv);
    }
    alertDiv.innerText = msg;
    alertDiv.style.display = 'block';
    setTimeout(() => { alertDiv.style.display = 'none'; }, 5000);
}
// --- Real-time AJAX Polling ---
function updateDashboardRealtime() {
    fetch('/api/status/')
        .then(r => r.json())
        .then(data => {
            if (data && data.temperature !== undefined) {
                document.querySelectorAll('.main div')[1].querySelector('div:nth-child(2)').innerText = (data.temperature || '-') + 'Â°C';
                document.querySelectorAll('.main div')[2].querySelector('div:nth-child(2)').innerText = (data.humidity || '-') + '%';
                // Status Daging
                var statusDiv = document.querySelectorAll('.main div')[3].querySelector('div:nth-child(2)');
                statusDiv.innerText = data.status || '-';
                statusDiv.style.color = (data.status === 'TIDAK LAYAK') ? '#c0392b' : (data.status === 'WARNING' ? '#ff9800' : (data.status === 'LAYAK' ? '#27ae60' : ''));
                // Gas
                document.getElementById('gaugeValue').innerText = (data.gas || '-') + '';
                // ALERT: suhu > 10Â°C atau gas > 30
                if ((parseFloat(data.temperature) > 10) || (parseFloat(data.gas) > 30)) {
                    showAlert('âš ï¸ Sensor mendeteksi kondisi abnormal! Suhu > 10Â°C atau Gas > 30.');
                }
            }
        });
    fetch('/api/history/')
        .then(r => r.json())
        .then(history => {
            if (Array.isArray(history) && history.length > 0) {
                // Update Chart.js
                var labels = history.slice().reverse().map(row => row.created_at.substr(11,8));
                var suhu = history.slice().reverse().map(row => row.temperature);
                var hum = history.slice().reverse().map(row => row.humidity);
                if (window.tempChart && window.humChart) {
                    window.tempChart.data.labels = labels;
                    window.tempChart.data.datasets[0].data = suhu;
                    window.tempChart.update();
                    window.humChart.data.labels = labels;
                    window.humChart.data.datasets[0].data = hum;
                    window.humChart.update();
                }
                // Update Table
                var table = document.querySelector('table');
                if (table) {
                    var rows = '';
                    for (var i=0; i<history.length; i++) {
                        var row = history[i];
                        rows += `<tr><td style="padding:4px;">${row.created_at.replace('T',' ').substr(0,19)}</td><td style="padding:4px;">${row.temperature ?? '-'}</td><td style="padding:4px;">${row.humidity ?? '-'}</td><td style="padding:4px;">${row.gas ?? '-'}</td>`;
                        if (row.status === 'TIDAK LAYAK') rows += `<td style="padding:4px;color:#c0392b;font-weight:bold;">${row.status}</td>`;
                        else if (row.status === 'WARNING') rows += `<td style="padding:4px;color:#ff9800;font-weight:bold;">${row.status}</td>`;
                        else if (row.status === 'LAYAK') rows += `<td style="padding:4px;color:#27ae60;font-weight:bold;">${row.status}</td>`;
                        else rows += `<td style="padding:4px;">${row.status ?? '-'}</td>`;
                        rows += '</tr>';
                    }
                    table.querySelectorAll('tr:not(:first-child)').forEach(e => e.remove());
                    table.innerHTML += rows;
                }
            }
        });
}
setInterval(updateDashboardRealtime, 3000);
window.addEventListener('DOMContentLoaded', function() {
    // Inisialisasi Chart.js global agar bisa diupdate
    if (typeof Chart !== 'undefined') {
        var labels = {{ labels_js|default:'[]'|safe }};
        var suhu = {{ suhu_js|default:'[]'|safe }};
        var hum = {{ hum_js|default:'[]'|safe }};
        window.tempChart = new Chart(document.getElementById('tempChart'), {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'Suhu (Â°C)', data: suhu, borderColor: '#5a67d8', backgroundColor: 'rgba(90,103,216,0.08)', tension: 0.3, fill: true, pointRadius: 3, pointHoverRadius: 6 }] },
            options: { plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#f1f1f1' } } } }
        });
        window.humChart = new Chart(document.getElementById('humChart'), {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'Kelembapan (%)', data: hum, backgroundColor: '#b9fbc0', borderRadius: 8 }] },
            options: { plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#f1f1f1' } } } }
        });
    }
    updateDashboardRealtime();
});
// Sidebar Engineer Expand/Collapse
function toggleEngineer() {
    var list = document.getElementById('engineerList');
    var arrow = document.getElementById('engineerArrow');
    if (list.style.display === 'none' || list.style.display === '') {
        list.style.display = 'block';
        arrow.classList.remove('fa-chevron-down');
        arrow.classList.add('fa-chevron-up');
    } else {
        list.style.display = 'none';
        arrow.classList.remove('fa-chevron-up');
        arrow.classList.add('fa-chevron-down');
    }
}
// Sidebar Jenis Sensor Expand/Collapse
function toggleJenisSensor() {
    var list = document.getElementById('jenisSensorList');
    var arrow = document.getElementById('jenisSensorArrow');
    if (list.style.display === 'none' || list.style.display === '') {
        list.style.display = 'block';
        arrow.classList.remove('fa-chevron-down');
        arrow.classList.add('fa-chevron-up');
    } else {
        list.style.display = 'none';
        arrow.classList.remove('fa-chevron-up');
        arrow.classList.add('fa-chevron-down');
    }
}
// Sidebar menu logic
function openSidebarMenu() {
    document.getElementById('sidebarMenu').classList.add('open');
    document.getElementById('sidebarOverlay').style.display = 'block';
}
function closeSidebarMenu() {
    document.getElementById('sidebarMenu').classList.remove('open');
    document.getElementById('sidebarOverlay').style.display = 'none';
}
// Modal logic
function showLogin() {
    document.getElementById('loginModal').style.display = 'flex';
}
function hideLogin() {
    document.getElementById('loginModal').style.display = 'none';
}
function showRegister() {
    document.getElementById('registerModal').style.display = 'flex';
}
function hideRegister() {
    document.getElementById('registerModal').style.display = 'none';
}
// --- AJAX Login/Register/Logout Logic ---
document.addEventListener('DOMContentLoaded', function() {
    // Login form submit
    var loginForm = document.querySelector('#loginModal form');
    if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var username = document.getElementById('loginUsername').value;
            var password = document.getElementById('loginPassword').value;
            fetch('/api/ajax_login/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: password })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    hideLogin();
                    location.reload();
                } else {
                    alert(data.message || 'Login gagal');
                }
            });
        });
    }
    // Register form submit
    var registerForm = document.querySelector('#registerModal form');
    if (registerForm) {
        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var email = document.getElementById('registerEmail').value;
            var username = document.getElementById('registerUsername').value;
            var password = document.getElementById('registerPassword').value;
            fetch('/api/ajax_register/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, username: username, password: password })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    hideRegister();
                    alert('Registrasi berhasil! Silakan login.');
                } else {
                    alert(data.message || 'Registrasi gagal');
                }
            });
        });
    }
});

function ajaxLogout() {
    fetch('/api/ajax_logout/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Logout gagal');
        }
    });
}
</script>

{% if history and history|length > 0 %}
<script>
// Chart.js logic (now at end of body)
var labels = {{ labels_js|default:'[]'|safe }};
var suhu = {{ suhu_js|default:'[]'|safe }};
var hum = {{ hum_js|default:'[]'|safe }};
// Suhu (Line Chart)
new Chart(document.getElementById('tempChart'), {
    type: 'line',
    data: { labels: labels, datasets: [{ label: 'Suhu (Â°C)', data: suhu, borderColor: '#5a67d8', backgroundColor: 'rgba(90,103,216,0.08)', tension: 0.3, fill: true, pointRadius: 3, pointHoverRadius: 6 }] },
    options: { plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#f1f1f1' } } } }
});
// Kelembapan (Bar Chart)
new Chart(document.getElementById('humChart'), {
    type: 'bar',
    data: { labels: labels, datasets: [{ label: 'Kelembapan (%)', data: hum, backgroundColor: '#b9fbc0', borderRadius: 8 }] },
    options: { plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#f1f1f1' } } } }
});
// Gas (Gauge Chart)
var gasVal = suhu.length > 0 ? Math.round(parseFloat("{{ data.gas|default:'0'|floatformat:2 }}") * 100) : 0;
new Chart(document.getElementById('gasGauge'), {
    type: 'doughnut',
    data: { datasets: [{ data: [gasVal, 100-gasVal], backgroundColor: ['#ffd6a5', '#f7f8fa'], borderWidth: 0, cutout: '80%', circumference: 180, rotation: 270 }] },
    options: { plugins: { legend: { display: false } }, responsive: false }
});
document.getElementById('gaugeValue').innerText = gasVal + '%';
</script>
{% endif %}
</script>

</body>
</html>
